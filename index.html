<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ads Transparency Scanner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #334155;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: #f8fafc;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    /* Navigation */
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .nav-tab {
      padding: 0.75rem 1.5rem;
      background: #1e293b;
      border: none;
      border-radius: 8px 8px 0 0;
      color: #94a3b8;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-tab:hover {
      background: #334155;
      color: #e2e8f0;
    }

    .nav-tab.active {
      background: #3b82f6;
      color: white;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Panels */
    .panel {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .panel-title {
      font-weight: 600;
      font-size: 1rem;
      color: #f8fafc;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }

    input[type="number"] {
      width: 100px;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      border: 2px solid #334155;
      border-radius: 8px;
      background: #0f172a;
      color: #f8fafc;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus {
      border-color: #3b82f6;
    }

    input[type="text"], input[type="url"] {
      width: 100%;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      border: 2px solid #334155;
      border-radius: 8px;
      background: #0f172a;
      color: #f8fafc;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus, input[type="url"]:focus {
      border-color: #3b82f6;
    }

    input::placeholder {
      color: #64748b;
    }

    .btn {
      padding: 0.875rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-primary:disabled {
      background: #475569;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-success {
      background: #22c55e;
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn-lg {
      padding: 1.25rem 3rem;
      font-size: 1.25rem;
    }

    /* Status */
    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #94a3b8;
      margin-top: 1rem;
    }

    .status.loading {
      color: #fbbf24;
    }

    .status.success {
      color: #22c55e;
    }

    .status.error {
      color: #ef4444;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress bar */
    .progress-container {
      margin: 1rem 0;
    }

    .progress-bar {
      height: 8px;
      background: #334155;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #3b82f6;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 0.5rem;
    }

    /* Results table */
    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #334155;
    }

    .results-table th {
      background: #334155;
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
    }

    .results-table tr:hover {
      background: #334155;
    }

    .results-table .domain {
      font-weight: 600;
      color: #f8fafc;
    }

    .results-table .publisher {
      color: #3b82f6;
      font-weight: 500;
    }

    .results-table .ads-count {
      font-size: 1.25rem;
      font-weight: 700;
      color: #22c55e;
    }

    .results-table .ads-count.zero {
      color: #64748b;
    }

    .results-table .timestamp {
      font-size: 0.8rem;
      color: #64748b;
    }

    .results-table .status-cell {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.success {
      background: #166534;
      color: #bbf7d0;
    }

    .status-badge.error {
      background: #7f1d1d;
      color: #fecaca;
    }

    .status-badge.pending {
      background: #854d0e;
      color: #fef08a;
    }

    .status-badge.scanning {
      background: #1e40af;
      color: #bfdbfe;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Settings saved message */
    .save-message {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      margin-top: 1rem;
      display: none;
    }

    .save-message.success {
      background: #166534;
      color: #bbf7d0;
      display: block;
    }

    .save-message.error {
      background: #7f1d1d;
      color: #fecaca;
      display: block;
    }

    /* Start section */
    .start-section {
      text-align: center;
      padding: 2rem;
    }

    .start-section p {
      color: #94a3b8;
      margin-bottom: 1.5rem;
    }

    .config-warning {
      background: #7f1d1d;
      color: #fecaca;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .config-warning a {
      color: #fecaca;
      text-decoration: underline;
    }

    /* Summary stats */
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: #0f172a;
      padding: 1.25rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card .label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f8fafc;
    }

    .stat-card .value.highlight {
      color: #3b82f6;
    }

    @media (max-width: 768px) {
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Auto-run styles */
    .auto-run-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #3b82f6;
      cursor: pointer;
    }

    .checkbox-wrapper label {
      font-size: 0.95rem;
      color: #e2e8f0;
      cursor: pointer;
    }

    .interval-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .interval-input span {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .auto-run-status {
      margin-top: 1rem;
      padding: 1rem;
      background: #0f172a;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .auto-run-status .status-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #334155;
    }

    .auto-run-status .status-row:last-child {
      border-bottom: none;
    }

    .auto-run-status .status-label {
      color: #94a3b8;
    }

    .auto-run-status .status-value {
      color: #f8fafc;
      font-weight: 500;
    }

    .auto-run-status .status-value.active {
      color: #22c55e;
    }

    .auto-run-status .status-value.inactive {
      color: #64748b;
    }

    .auto-run-indicator-panel {
      background: linear-gradient(135deg, #1e3a2f 0%, #14532d 100%);
      border: 1px solid #22c55e40;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin: 1rem auto;
      max-width: 400px;
      text-align: left;
    }

    .auto-run-indicator-panel.running {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
      border-color: #3b82f640;
    }

    .auto-run-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #22c55e30;
    }

    .auto-run-indicator-panel.running .auto-run-header {
      border-bottom-color: #3b82f630;
    }

    .auto-run-title {
      color: #4ade80;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .auto-run-indicator-panel.running .auto-run-title {
      color: #60a5fa;
    }

    .auto-run-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem 1rem;
    }

    .auto-run-detail {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .detail-label {
      color: #94a3b8;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      color: #e2e8f0;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .pulse-dot {
      width: 10px;
      height: 10px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 8px #22c55e80;
    }

    .auto-run-indicator-panel.running .pulse-dot {
      background: #3b82f6;
      box-shadow: 0 0 8px #3b82f680;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    /* Run Plan Panel */
    .run-plan-panel {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin: 1rem auto 1.5rem;
      max-width: 500px;
    }

    .run-plan-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .run-plan-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .run-plan-item {
      text-align: center;
    }

    .run-plan-label {
      display: block;
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 0.25rem;
    }

    .run-plan-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: #3b82f6;
    }

    /* Detailed Progress Panel */
    .progress-panel {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 1.25rem;
      margin: 1rem auto;
      max-width: 600px;
    }

    .progress-section {
      margin-bottom: 1.25rem;
    }

    .progress-section:last-child {
      margin-bottom: 0;
    }

    .progress-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 0.5rem;
    }

    .progress-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .progress-stats {
      display: flex;
      gap: 1rem;
    }

    .stat-success {
      color: #22c55e;
    }

    .stat-error {
      color: #ef4444;
    }

    .progress-current {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #64748b;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ads Transparency Scanner</h1>
      <p class="subtitle">Scan domains for Google Ads transparency data</p>
      <div id="driveAuthBanner" class="config-warning" style="display: none; margin-top: 1rem;">
        Google Drive not authorized. <a href="/auth" target="_blank">Click here to authorize</a> for screenshot uploads.
      </div>
    </header>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('main')">Scanner</button>
      <button class="nav-tab" onclick="showPage('settings')">Settings</button>
    </div>

    <!-- Main Scanner Page -->
    <div id="mainPage" class="page active">
      <div class="panel">
        <div class="start-section">
          <div id="configWarning" class="config-warning" style="display: none;">
            Apps Script URL not configured. <a href="#" onclick="showPage('settings')">Go to Settings</a> to set it up.
          </div>
          <p id="domainCount">Configure Apps Script URL in Settings to load domains</p>
          <div id="autoRunIndicator" class="auto-run-indicator-panel" style="display: none;">
            <div class="auto-run-header">
              <div class="pulse-dot"></div>
              <span class="auto-run-title" id="autoRunTitle">Auto-Run Active</span>
            </div>
            <div class="auto-run-details">
              <div class="auto-run-detail">
                <span class="detail-label">Interval</span>
                <span class="detail-value" id="autoRunIntervalDisplay">1 min</span>
              </div>
              <div class="auto-run-detail">
                <span class="detail-label">Domains</span>
                <span class="detail-value" id="autoRunDomainsDisplay">0</span>
              </div>
              <div class="auto-run-detail">
                <span class="detail-label">Last Run</span>
                <span class="detail-value" id="autoRunLastRunDisplay">Never</span>
              </div>
              <div class="auto-run-detail">
                <span class="detail-label">Next Run</span>
                <span class="detail-value" id="autoRunNextRunDisplay">-</span>
              </div>
            </div>
          </div>
          <!-- Run Plan Panel -->
          <div id="runPlanPanel" class="run-plan-panel" style="display: none;">
            <div class="run-plan-title">Run Plan</div>
            <div class="run-plan-grid">
              <div class="run-plan-item">
                <span class="run-plan-label">Domains to scan</span>
                <span class="run-plan-value" id="planDomains">0</span>
              </div>
              <div class="run-plan-item">
                <span class="run-plan-label">Batch size</span>
                <span class="run-plan-value" id="planBatchSize">5</span>
              </div>
              <div class="run-plan-item">
                <span class="run-plan-label">Batches to send</span>
                <span class="run-plan-value" id="planBatches">0</span>
              </div>
            </div>
          </div>

          <button class="btn btn-success btn-lg" id="startBtn" onclick="startBatchScan()" disabled>
            START
          </button>

          <!-- Detailed Progress Panel -->
          <div id="progressPanel" class="progress-panel" style="display: none;">
            <div id="timerDisplay" style="text-align:center;margin-bottom:1rem;font-size:1.75rem;font-weight:700;font-variant-numeric:tabular-nums;color:#3b82f6;letter-spacing:0.05em;">00:00:00</div>
            <div class="progress-section">
              <div class="progress-section-title">Scanning Domains</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
              </div>
              <div class="progress-details">
                <span id="progressText">0 / 0</span>
                <span class="progress-stats">
                  <span class="stat-success" id="scanSuccessCount">0 success</span>
                  <span class="stat-error" id="scanErrorCount">0 errors</span>
                </span>
              </div>
              <div class="progress-current" id="currentDomain"></div>
            </div>

            <div class="progress-section" id="sheetsSection" style="display: none;">
              <div class="progress-section-title">Sending to Sheets</div>
              <div class="progress-bar">
                <div class="progress-fill" id="sheetsProgressFill" style="width: 0%; background: #22c55e;"></div>
              </div>
              <div class="progress-details">
                <span id="sheetsProgressText">Batch 0 / 0</span>
                <span class="progress-stats">
                  <span class="stat-success" id="sheetsSavedCount">0 saved</span>
                  <span class="stat-error" id="sheetsFailedCount">0 failed</span>
                </span>
              </div>
            </div>
          </div>

          <div class="status" id="status"></div>
        </div>
      </div>

      <div class="panel" id="resultsPanel" style="display: none;">
        <div class="panel-header">
          <span class="panel-title">Scan Results</span>
          <button class="btn btn-secondary" onclick="clearResults()">Clear</button>
        </div>

        <div class="summary-stats" id="summaryStats">
          <div class="stat-card">
            <div class="label">Total Domains</div>
            <div class="value" id="statDomains">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Ads</div>
            <div class="value highlight" id="statTotalAds">0</div>
          </div>
          <div class="stat-card">
            <div class="label">With Ads</div>
            <div class="value" id="statWithAds">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Scan Time</div>
            <div class="value" id="statScanTime">-</div>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table class="results-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Publisher</th>
                <th>Location</th>
                <th>Total Ads</th>
                <th>In View</th>
                <th>Format</th>
                <th>Last Seen</th>
                <th>Scanned At</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="settingsPage" class="page">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Apps Script Configuration</span>
        </div>

        <div class="form-group">
          <label class="form-label">Apps Script Web App URL</label>
          <input type="url" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/xxxxx/exec" />
        </div>

        <div class="form-group">
          <label class="form-label">Batch Size (results per request to Sheets)</label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="number" id="batchSize" value="5" min="1" max="20" style="width: 80px;" />
            <span style="color: #64748b; font-size: 0.85rem;">results per batch (1-20, recommended: 5)</span>
          </div>
        </div>

        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1.5rem;">
          Enter the deployed Web App URL from your Google Apps Script.
          Results are sent to Sheets in batches to avoid Apps Script limitations.
          See <code>apps-script.js</code> for setup instructions.
        </p>

        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        <button class="btn btn-secondary" onclick="testConnection()" style="margin-left: 0.5rem;">Test Connection</button>

        <div class="save-message" id="saveMessage"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Auto-Run Scheduler</span>
        </div>

        <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 1.5rem;">
          Enable automatic scanning at regular intervals. The scanner will run on the server even if you close this browser tab.
        </p>

        <div class="auto-run-container">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="autoRunEnabled" onchange="toggleAutoRun()">
            <label for="autoRunEnabled">Enable Auto-Run</label>
          </div>

          <div class="interval-input">
            <span>Run every</span>
            <input type="number" id="autoRunInterval" value="1" min="1" max="1440">
            <span>minutes</span>
          </div>
        </div>

        <div class="auto-run-status" id="autoRunStatus">
          <div class="status-row">
            <span class="status-label">Status</span>
            <span class="status-value inactive" id="autoRunStatusValue">Disabled</span>
          </div>
          <div class="status-row">
            <span class="status-label">Last Run</span>
            <span class="status-value" id="autoRunLastRun">Never</span>
          </div>
          <div class="status-row">
            <span class="status-label">Next Run</span>
            <span class="status-value" id="autoRunNextRun">-</span>
          </div>
          <div class="status-row">
            <span class="status-label">Domains</span>
            <span class="status-value" id="autoRunDomains">0</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Setup Instructions</span>
        </div>
        <ol style="color: #94a3b8; line-height: 2; padding-left: 1.5rem;">
          <li>Open your Google Sheet</li>
          <li>Create a sheet tab named <strong>CONFIG</strong></li>
          <li>Add domains in column A (one per row, starting from row 2)</li>
          <li>Go to <strong>Extensions > Apps Script</strong></li>
          <li>Copy the code from <code>apps-script.js</code> and paste it</li>
          <li>Click <strong>Deploy > New deployment</strong></li>
          <li>Select type: <strong>Web app</strong></li>
          <li>Set "Execute as": <strong>Me</strong></li>
          <li>Set "Who has access": <strong>Anyone</strong></li>
          <li>Click <strong>Deploy</strong> and copy the Web App URL</li>
          <li>Paste the URL above and click <strong>Save Settings</strong></li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    // State
    let settings = JSON.parse(localStorage.getItem('adsSettings') || '{}');
    let scanResults = [];
    let isScanning = false;

    // Format date in Israeli timezone with timezone indicator
    function formatIsraeliDate(date) {
      const options = {
        timeZone: 'Asia/Jerusalem',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      };
      const formatted = date.toLocaleString('he-IL', options);

      // Determine if it's IST (winter) or IDT (summer)
      const jan = new Date(date.getFullYear(), 0, 1).getTimezoneOffset();
      const jul = new Date(date.getFullYear(), 6, 1).getTimezoneOffset();
      const israelOffset = date.toLocaleString('en-US', { timeZone: 'Asia/Jerusalem', timeZoneName: 'short' });
      const tzMatch = israelOffset.match(/([A-Z]{2,4})$/);
      const tz = tzMatch ? tzMatch[1] : 'IST';

      return `${formatted} (${tz})`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      checkConfiguration();
      checkAutoRunStatus();
      checkDriveAuth();
      // Poll auto-run status every 30 seconds
      setInterval(checkAutoRunStatus, 30000);
    });

    // Check Google Drive authorization status
    async function checkDriveAuth() {
      try {
        const resp = await fetch('/drive-status');
        const data = await resp.json();
        const banner = document.getElementById('driveAuthBanner');
        banner.style.display = data.authenticated ? 'none' : 'block';
      } catch (e) {
        console.error('Failed to check Drive auth:', e);
      }
    }

    // Navigation
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

      document.getElementById(page + 'Page').classList.add('active');
      event.target.classList.add('active');
    }

    // Settings
    function loadSettings() {
      if (settings.appsScriptUrl) {
        document.getElementById('appsScriptUrl').value = settings.appsScriptUrl;
      }
      if (settings.batchSize) {
        document.getElementById('batchSize').value = settings.batchSize;
      } else {
        settings.batchSize = 5; // Default
      }
    }

    function saveSettings() {
      const url = document.getElementById('appsScriptUrl').value.trim();
      const batchSize = parseInt(document.getElementById('batchSize').value) || 5;

      if (!url) {
        showSaveMessage('Please enter a valid URL', 'error');
        return;
      }

      if (batchSize < 1 || batchSize > 20) {
        showSaveMessage('Batch size must be between 1 and 20', 'error');
        return;
      }

      settings.appsScriptUrl = url;
      settings.batchSize = batchSize;
      localStorage.setItem('adsSettings', JSON.stringify(settings));

      showSaveMessage('Settings saved successfully!', 'success');
      checkConfiguration();
      updateRunPlan();
    }

    function showSaveMessage(message, type) {
      const el = document.getElementById('saveMessage');
      el.textContent = message;
      el.className = 'save-message ' + type;

      setTimeout(() => {
        el.className = 'save-message';
      }, 3000);
    }

    async function testConnection() {
      const url = document.getElementById('appsScriptUrl').value.trim();

      if (!url) {
        showSaveMessage('Please enter a URL first', 'error');
        return;
      }

      showSaveMessage('Testing connection...', 'success');

      try {
        // Use proxy to avoid CORS
        const proxyUrl = `/proxy?url=${encodeURIComponent(url + '?action=health')}`;
        const response = await fetch(proxyUrl);
        const data = await response.json();

        if (data.status === 'ok') {
          showSaveMessage('Connection successful!', 'success');
        } else {
          showSaveMessage('Connection failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showSaveMessage('Connection failed: ' + error.message, 'error');
      }
    }

    // Configuration check
    async function checkConfiguration() {
      const warning = document.getElementById('configWarning');
      const btn = document.getElementById('startBtn');
      const countEl = document.getElementById('domainCount');

      if (!settings.appsScriptUrl) {
        warning.style.display = 'block';
        btn.disabled = true;
        countEl.textContent = 'Configure Apps Script URL in Settings to load domains';
        return;
      }

      warning.style.display = 'none';
      countEl.textContent = 'Loading domains...';

      try {
        // Use proxy to avoid CORS
        const proxyUrl = `/proxy?url=${encodeURIComponent(settings.appsScriptUrl + '?action=getDomains')}`;
        const response = await fetch(proxyUrl);
        const data = await response.json();

        if (data.success && data.domains) {
          // Clean domains: remove https://, http://, www. and trailing slashes
          settings.domains = data.domains.map(d =>
            d.replace(/^https?:\/\//, '').replace(/^www\./, '').replace(/\/+$/, '')
          );
          countEl.textContent = `${settings.domains.length} domains loaded from Google Sheet`;
          btn.disabled = settings.domains.length === 0;

          // Show run plan
          updateRunPlan();
        } else {
          countEl.textContent = 'Error: ' + (data.error || 'Failed to load domains');
          btn.disabled = true;
          document.getElementById('runPlanPanel').style.display = 'none';
        }
      } catch (error) {
        countEl.textContent = 'Error loading domains: ' + error.message;
        btn.disabled = true;
        document.getElementById('runPlanPanel').style.display = 'none';
      }
    }

    function updateRunPlan() {
      const domainsCount = settings.domains?.length || 0;
      const batchSize = settings.batchSize || 5;
      const batchesCount = Math.ceil(domainsCount / batchSize);

      document.getElementById('planDomains').textContent = domainsCount;
      document.getElementById('planBatchSize').textContent = batchSize;
      document.getElementById('planBatches').textContent = batchesCount;

      if (domainsCount > 0) {
        document.getElementById('runPlanPanel').style.display = 'block';
      } else {
        document.getElementById('runPlanPanel').style.display = 'none';
      }
    }

    // Scanning
    let scanStats = { success: 0, errors: 0 };
    let timerInterval = null;

    function startTimer() {
      const timerEl = document.getElementById('timerDisplay');
      const start = Date.now();
      timerEl.style.color = '#3b82f6';
      const pad = n => String(n).padStart(2, '0');
      const tick = () => {
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const h = Math.floor(elapsed / 3600);
        const m = Math.floor((elapsed % 3600) / 60);
        const s = elapsed % 60;
        timerEl.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
      };
      tick();
      timerInterval = setInterval(tick, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('timerDisplay').style.color = '#22c55e';
    }

    function setStatus(message, type = '') {
      const status = document.getElementById('status');
      status.className = 'status ' + type;
      status.innerHTML = type === 'loading'
        ? `<div class="spinner"></div><span>${message}</span>`
        : `<span>${message}</span>`;
    }

    function updateProgress(current, total, currentDomain = '') {
      const panel = document.getElementById('progressPanel');
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');
      const successEl = document.getElementById('scanSuccessCount');
      const errorEl = document.getElementById('scanErrorCount');
      const currentEl = document.getElementById('currentDomain');

      panel.style.display = 'block';
      const percent = total > 0 ? (current / total) * 100 : 0;
      fill.style.width = percent + '%';
      text.textContent = `${current} / ${total}`;
      successEl.textContent = `${scanStats.success} success`;
      errorEl.textContent = `${scanStats.errors} errors`;
      currentEl.textContent = currentDomain ? `Scanning: ${currentDomain}` : '';
    }

    async function startBatchScan() {
      if (isScanning || !settings.domains || settings.domains.length === 0) return;

      isScanning = true;
      scanResults = [];
      scanStats = { success: 0, errors: 0 };
      const batchSize = settings.batchSize || 5;
      const totalDomains = settings.domains.length;
      const totalBatches = Math.ceil(totalDomains / batchSize);
      let sheetsStats = { saved: 0, failed: 0, batchesSent: 0 };
      const startTime = new Date();

      const btn = document.getElementById('startBtn');
      btn.disabled = true;

      // Hide run plan, show progress panel
      document.getElementById('runPlanPanel').style.display = 'none';
      document.getElementById('progressPanel').style.display = 'block';
      document.getElementById('sheetsSection').style.display = 'block';
      updateSheetsProgress(0, totalBatches, 0, 0);

      document.getElementById('resultsPanel').style.display = 'block';
      document.getElementById('resultsBody').innerHTML = '';

      // Initialize table with pending status for all domains
      settings.domains.forEach(domain => {
        addResultRow({
          domain: domain,
          publisherName: '-',
          publisherId: '-',
          creativeId: '-',
          publisherVerified: false,
          publisherLocation: '-',
          totalAds: '-',
          adFormats: [],
          lastSeenDate: '-',
          scannedAt: '-',
          status: 'pending'
        });
      });

      setStatus('Starting batch scan...', 'loading');
      updateProgress(0, totalDomains, '');
      startTimer();

      // Process domains in batches: scan batchSize, send to sheets, repeat
      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
        const batchStart = batchIndex * batchSize;
        const batchEnd = Math.min(batchStart + batchSize, totalDomains);
        const batchDomains = settings.domains.slice(batchStart, batchEnd);
        const batchNum = batchIndex + 1;
        let batchResults = [];

        // --- SCAN this batch ---
        for (let j = 0; j < batchDomains.length; j++) {
          const domain = batchDomains[j];
          const globalIndex = batchStart + j;

          updateProgress(globalIndex, totalDomains, domain);
          setStatus(`Batch ${batchNum}/${totalBatches} — Scanning domain ${globalIndex + 1} of ${totalDomains}...`, 'loading');

          // Update row to scanning status
          updateResultRow(domain, { status: 'scanning' });

          try {
            const response = await fetch(`/scrape?domain=${encodeURIComponent(domain)}`);
            const result = await response.json();

            if (result.success && result.data) {
              const data = result.data;

              // Upload screenshot to Drive via Drive API
              let screenshotDriveUrl = '-';
              if (data.screenshot) {
                try {
                  const uploadResp = await fetch('/upload-screenshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      base64: data.screenshot,
                      domain: domain
                    })
                  });
                  const uploadData = await uploadResp.json();
                  if (uploadData.success && uploadData.downloadUrl) {
                    screenshotDriveUrl = uploadData.downloadUrl;
                    console.log(`Screenshot uploaded for ${domain}: ${screenshotDriveUrl}`);
                  }
                } catch (uploadErr) {
                  console.error(`Screenshot upload failed for ${domain}:`, uploadErr);
                }
              }

              const publishers = data.publishers || [];
              const adsInView = data.ads?.length || 0;

              if (publishers.length > 0) {
                // Create one row per unique publisher
                const rows = [];
                for (const pub of publishers) {
                  const firstAd = pub.ads?.[0];
                  const crId = firstAd?.creativeId;
                  rows.push({
                    domain: domain,
                    publisherName: pub.name || '-',
                    publisherId: pub.id || '-',
                    creativeId: crId || '-',
                    publisherVerified: pub.verified || false,
                    publisherLocation: pub.location || '-',
                    totalAds: data.totalAds || 0,
                    adsInView: adsInView,
                    adFormats: pub.adFormats || [],
                    lastSeenDate: pub.lastSeenDate || '-',
                    adImageUrl: screenshotDriveUrl,
                    adText: firstAd?.adText?.replace(/מאומת/g, '').trim() || '-',
                    adsTransparencyUrl: `https://adstransparency.google.com/?region=anywhere&domain=${domain}`,
                    scannedAt: formatIsraeliDate(new Date()),
                    status: 'success'
                  });
                }
                replaceResultRows(domain, rows);
                rows.forEach(r => { scanResults.push(r); batchResults.push(r); });
                scanStats.success++;
              } else {
                // Fallback: single row
                const firstAd = data.ads?.[0];
                const pubId = data.advertiser?.id;
                const crId = firstAd?.creativeId;
                const rowData = {
                  domain: domain,
                  publisherName: data.advertiser?.name || '-',
                  publisherId: pubId || '-',
                  creativeId: crId || '-',
                  publisherVerified: data.advertiser?.verified || false,
                  publisherLocation: data.advertiser?.location || '-',
                  totalAds: data.totalAds || 0,
                  adsInView: adsInView,
                  adFormats: data.adFormats || [],
                  lastSeenDate: data.lastSeenDate || '-',
                  adImageUrl: screenshotDriveUrl,
                  adText: data.ads?.[0]?.adText || '-',
                  adsTransparencyUrl: `https://adstransparency.google.com/?region=anywhere&domain=${domain}`,
                  scannedAt: formatIsraeliDate(new Date()),
                  status: 'success'
                };
                scanResults.push(rowData);
                batchResults.push(rowData);
                updateResultRow(domain, rowData);
                scanStats.success++;
              }
            } else {
              const rowData = {
                domain: domain,
                publisherName: '-',
                publisherId: '-',
                creativeId: '-',
                publisherVerified: false,
                publisherLocation: '-',
                totalAds: 0,
                adsInView: 0,
                adFormats: [],
                lastSeenDate: '-',
                adImageUrl: '-',
                adText: '-',
                adsTransparencyUrl: `https://adstransparency.google.com/?region=anywhere&domain=${domain}`,
                scannedAt: formatIsraeliDate(new Date()),
                status: 'error',
                error: result.error
              };

              scanResults.push(rowData);
              batchResults.push(rowData);
              updateResultRow(domain, rowData);
              scanStats.errors++;
            }
          } catch (error) {
            const rowData = {
              domain: domain,
              publisherName: '-',
              publisherId: '-',
              creativeId: '-',
              publisherVerified: false,
              publisherLocation: '-',
              totalAds: 0,
              adsInView: 0,
              adFormats: [],
              lastSeenDate: '-',
              adImageUrl: '-',
              adText: '-',
              adsTransparencyUrl: `https://adstransparency.google.com/?region=anywhere&domain=${domain}`,
              scannedAt: formatIsraeliDate(new Date()),
              status: 'error',
              error: error.message
            };

            scanResults.push(rowData);
            batchResults.push(rowData);
            updateResultRow(domain, rowData);
            scanStats.errors++;
          }

          // Small delay between requests
          if (j < batchDomains.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        }

        // Update scan progress after batch completes
        updateProgress(batchEnd, totalDomains, '');

        // --- SEND this batch to Sheets ---
        if (settings.appsScriptUrl && batchResults.length > 0) {
          setStatus(`Batch ${batchNum}/${totalBatches} — Sending ${batchResults.length} results to Sheets...`, 'loading');

          const sendResult = await sendBatchToSheets(batchResults);
          sheetsStats.batchesSent++;

          if (sendResult.success) {
            sheetsStats.saved += sendResult.savedCount;
          } else {
            sheetsStats.failed++;
          }

          updateSheetsProgress(sheetsStats.batchesSent, totalBatches, sheetsStats.saved, sheetsStats.failed);
        }

        // Delay between batches
        if (batchIndex < totalBatches - 1) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }

      // Final updates
      stopTimer();
      updateProgress(totalDomains, totalDomains, '');
      document.getElementById('currentDomain').textContent = 'Done!';
      updateSheetsProgress(totalBatches, totalBatches, sheetsStats.saved, sheetsStats.failed);

      const endTime = new Date();
      const duration = Math.round((endTime - startTime) / 1000);
      updateSummaryStats(duration);

      if (sheetsStats.failed === 0) {
        setStatus(`Done! ${duration}s — ${scanStats.success} success, ${scanStats.errors} errors — ${sheetsStats.saved} saved to Sheets (${totalBatches} batches)`, 'success');
      } else {
        setStatus(`Done! ${duration}s — ${scanStats.success} success, ${scanStats.errors} errors — ${sheetsStats.saved} saved, ${sheetsStats.failed} batch(es) failed`, 'error');
      }

      // Show run plan again after completion
      updateRunPlan();

      btn.disabled = false;
      isScanning = false;
    }

    function addResultRow(data) {
      const tbody = document.getElementById('resultsBody');
      const tr = document.createElement('tr');
      tr.id = 'row-' + data.domain.replace(/\./g, '-');
      tr.innerHTML = getRowHtml(data);
      tbody.appendChild(tr);
    }

    function updateResultRow(domain, data) {
      const rowId = 'row-' + domain.replace(/\./g, '-');
      const tr = document.getElementById(rowId);
      if (tr) {
        tr.innerHTML = getRowHtml({ ...data, domain });
      }
    }

    function replaceResultRows(domain, rows) {
      const rowId = 'row-' + domain.replace(/\./g, '-');
      const existingRow = document.getElementById(rowId);
      const tbody = document.getElementById('resultsBody');

      if (rows.length === 1) {
        // Single publisher - simple update
        if (existingRow) {
          existingRow.innerHTML = getRowHtml(rows[0]);
        }
      } else {
        // Multiple publishers - remove old row, add multiple new rows
        const insertBefore = existingRow ? existingRow.nextSibling : null;
        if (existingRow) existingRow.remove();

        rows.forEach((rowData, i) => {
          const tr = document.createElement('tr');
          tr.id = rowId + '-pub-' + i;
          tr.innerHTML = getRowHtml(rowData);
          if (insertBefore) {
            tbody.insertBefore(tr, insertBefore);
          } else {
            tbody.appendChild(tr);
          }
        });
      }
    }

    function getRowHtml(data) {
      const adsClass = data.totalAds === 0 || data.totalAds === '-' ? 'zero' : '';
      const statusClass = data.status;
      const statusText = data.status === 'scanning' ? 'Scanning...' :
                         data.status === 'pending' ? 'Pending' :
                         data.status === 'success' ? 'Done' : 'Error';
      const formats = Array.isArray(data.adFormats) ? data.adFormats.join(', ') : (data.adFormats || '-');
      const verifiedBadge = data.publisherVerified ? ' <span style="color: #22c55e;">✓</span>' : '';

      const inView = data.adsInView !== undefined ? data.adsInView : '-';

      return `
        <td class="domain">${data.domain}</td>
        <td class="publisher">${data.publisherName}${verifiedBadge}</td>
        <td>${data.publisherLocation || '-'}</td>
        <td class="ads-count ${adsClass}">${data.totalAds}</td>
        <td style="color: #94a3b8;">${inView}</td>
        <td>${formats}</td>
        <td style="font-size: 0.85rem;">${data.lastSeenDate || '-'}</td>
        <td class="timestamp">${data.scannedAt}</td>
        <td>
          <span class="status-badge ${statusClass}">${statusText}</span>
          ${data.error ? `<span style="color: #ef4444; font-size: 0.75rem; display: block; margin-top: 0.25rem;">${data.error}</span>` : ''}
        </td>
      `;
    }

    function updateSummaryStats(duration) {
      // Count unique domains (a domain may have multiple publisher rows)
      const uniqueDomains = [...new Set(scanResults.map(r => r.domain))];
      const totalAds = uniqueDomains.reduce((sum, domain) => {
        const first = scanResults.find(r => r.domain === domain);
        return sum + (parseInt(first?.totalAds) || 0);
      }, 0);
      const withAds = uniqueDomains.filter(domain => {
        const first = scanResults.find(r => r.domain === domain);
        return (parseInt(first?.totalAds) || 0) > 0;
      }).length;

      document.getElementById('statDomains').textContent = uniqueDomains.length;
      document.getElementById('statTotalAds').textContent = totalAds.toLocaleString();
      document.getElementById('statWithAds').textContent = withAds;
      document.getElementById('statScanTime').textContent = duration + 's';
    }

    function clearResults() {
      scanResults = [];
      document.getElementById('resultsBody').innerHTML = '';
      document.getElementById('resultsPanel').style.display = 'none';
      document.getElementById('progressPanel').style.display = 'none';
      setStatus('');
      updateRunPlan();
    }

    async function sendBatchToSheets(batchResults) {
      const prepared = batchResults.map(r => ({
        domain: r.domain,
        publisherName: r.publisherName,
        publisherId: r.publisherId,
        creativeId: r.creativeId,
        publisherVerified: r.publisherVerified,
        publisherLocation: r.publisherLocation,
        totalAds: r.totalAds,
        adsInView: r.adsInView || 0,
        adFormats: r.adFormats,
        lastSeenDate: r.lastSeenDate,
        adImageUrl: r.adImageUrl,
        adText: r.adText ? r.adText.replace(/מאומת/g, '').trim() : r.adText,
        adsTransparencyUrl: r.adsTransparencyUrl,
        scanDate: r.scannedAt
      }));

      try {
        const proxyUrl = `/proxy?url=${encodeURIComponent(settings.appsScriptUrl)}`;
        const response = await fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveResults',
            results: prepared
          })
        });

        const data = await response.json();

        if (data.success) {
          return { success: true, savedCount: data.savedCount || prepared.length };
        } else {
          console.error('Batch send failed:', data.error);
          return { success: false, savedCount: 0 };
        }
      } catch (error) {
        console.error('Batch send error:', error.message);
        return { success: false, savedCount: 0 };
      }
    }

    function updateSheetsProgress(current, total, saved, failed) {
      const section = document.getElementById('sheetsSection');
      const fill = document.getElementById('sheetsProgressFill');
      const text = document.getElementById('sheetsProgressText');
      const savedEl = document.getElementById('sheetsSavedCount');
      const failedEl = document.getElementById('sheetsFailedCount');

      section.style.display = 'block';
      const percent = total > 0 ? (current / total) * 100 : 0;
      fill.style.width = percent + '%';
      text.textContent = `Batch ${current} / ${total}`;
      savedEl.textContent = `${saved} saved`;
      failedEl.textContent = `${failed} failed`;
    }

    // Auto-Run Functions
    async function checkAutoRunStatus() {
      try {
        const response = await fetch('/auto-run/status');
        const data = await response.json();

        updateAutoRunUI(data);
      } catch (error) {
        console.error('Failed to check auto-run status:', error);
      }
    }

    function updateAutoRunUI(data) {
      const checkbox = document.getElementById('autoRunEnabled');
      const intervalInput = document.getElementById('autoRunInterval');
      const statusValue = document.getElementById('autoRunStatusValue');
      const lastRun = document.getElementById('autoRunLastRun');
      const nextRun = document.getElementById('autoRunNextRun');
      const domainsCount = document.getElementById('autoRunDomains');
      const indicator = document.getElementById('autoRunIndicator');

      checkbox.checked = data.enabled;
      if (data.intervalMinutes) {
        intervalInput.value = data.intervalMinutes;
      }

      // Update home page indicator
      const titleEl = document.getElementById('autoRunTitle');
      const intervalDisplay = document.getElementById('autoRunIntervalDisplay');
      const domainsDisplay = document.getElementById('autoRunDomainsDisplay');
      const lastRunDisplay = document.getElementById('autoRunLastRunDisplay');
      const nextRunDisplay = document.getElementById('autoRunNextRunDisplay');

      if (data.enabled) {
        statusValue.textContent = data.isRunning ? 'Running...' : 'Active';
        statusValue.className = 'status-value active';
        indicator.style.display = 'block';

        if (data.isRunning) {
          indicator.className = 'auto-run-indicator-panel running';
          titleEl.textContent = 'Scanning in Progress...';
        } else {
          indicator.className = 'auto-run-indicator-panel';
          titleEl.textContent = 'Auto-Run Active';
        }

        // Update details
        intervalDisplay.textContent = data.intervalMinutes + ' min';
        domainsDisplay.textContent = data.domainsCount || 0;
        lastRunDisplay.textContent = data.lastRunTime
          ? formatIsraeliDate(new Date(data.lastRunTime))
          : 'Never';
        nextRunDisplay.textContent = data.nextRunTime
          ? formatIsraeliDate(new Date(data.nextRunTime))
          : '-';
      } else {
        statusValue.textContent = 'Disabled';
        statusValue.className = 'status-value inactive';
        indicator.style.display = 'none';
        indicator.className = 'auto-run-indicator-panel';
      }

      lastRun.textContent = data.lastRunTime
        ? formatIsraeliDate(new Date(data.lastRunTime))
        : 'Never';

      nextRun.textContent = data.nextRunTime
        ? formatIsraeliDate(new Date(data.nextRunTime))
        : '-';

      domainsCount.textContent = data.domainsCount || 0;
    }

    async function toggleAutoRun() {
      const checkbox = document.getElementById('autoRunEnabled');
      const intervalInput = document.getElementById('autoRunInterval');

      if (checkbox.checked) {
        // Start auto-run
        if (!settings.domains || settings.domains.length === 0) {
          alert('Please configure and load domains first');
          checkbox.checked = false;
          return;
        }

        const intervalMinutes = parseInt(intervalInput.value) || 1;

        if (intervalMinutes < 1) {
          alert('Interval must be at least 1 minute');
          checkbox.checked = false;
          return;
        }

        try {
          const response = await fetch('/auto-run/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              intervalMinutes: intervalMinutes,
              appsScriptUrl: settings.appsScriptUrl,
              domains: settings.domains,
              batchSize: settings.batchSize || 5
            })
          });

          const data = await response.json();

          if (data.success) {
            showSaveMessage(`Auto-run started! Running every ${intervalMinutes} minutes.`, 'success');
            checkAutoRunStatus();
          } else {
            alert('Failed to start auto-run: ' + data.error);
            checkbox.checked = false;
          }
        } catch (error) {
          alert('Failed to start auto-run: ' + error.message);
          checkbox.checked = false;
        }
      } else {
        // Stop auto-run
        try {
          await fetch('/auto-run/stop', { method: 'POST' });
          showSaveMessage('Auto-run stopped.', 'success');
          checkAutoRunStatus();
        } catch (error) {
          console.error('Failed to stop auto-run:', error);
        }
      }
    }
  </script>
</body>
</html>
